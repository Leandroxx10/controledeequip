<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Gerenciador de Equipamentos — Firestore Integrado (Completo)</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root{--primary:#2c3e50;--secondary:#3498db;--success:#2ecc71;--accent:#e74c3c;--light:#ecf0f1;--dark:#2c3e50;--gray:#7f8c8d;--radius:12px;--shadow:0 6px 18px rgba(0,0,0,0.08);}
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Montserrat',sans-serif}
    body{background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);color:var(--dark);min-height:100vh;padding:20px}
    .container{max-width:1400px;margin:0 auto}
    header{background:linear-gradient(135deg,var(--primary),#1a2530);color:#fff;padding:18px;border-radius:12px;text-align:center;box-shadow:var(--shadow);margin-bottom:18px}
    h1{font-size:1.6rem}
    .top-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .lang-select{padding:8px 12px;border-radius:6px;border:none;cursor:pointer;font-weight:600}
    .dashboard{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:18px}
    .dashboard-card{background:#fff;padding:14px;border-radius:10px;text-align:center;box-shadow:var(--shadow)}
    .search-container{background:#fff;padding:14px;border-radius:10px;box-shadow:var(--shadow);margin-bottom:18px}
    .search-box{display:flex;gap:12px;align-items:center}
    .search-input{flex:1;padding:10px;border-radius:50px;border:1px solid #ddd}
    .add-button,.search-button,.defects-button{padding:10px 14px;border-radius:50px;border:none;cursor:pointer}
    .add-button{background:var(--success);color:#fff}
    .search-button{background:linear-gradient(135deg,var(--secondary),#2980b9);color:#fff}
    .defects-button{background:linear-gradient(135deg,#8e44ad,#9b59b6);color:#fff}
    .filters{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap}
    .filter-button{padding:8px 14px;border-radius:50px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .filter-button.active{background:var(--secondary);color:#fff;border-color:var(--secondary)}
    .equipment-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:18px}
    .equipment-card{background:#fff;border-radius:12px;box-shadow:var(--shadow);overflow:hidden;padding:12px;display:flex;gap:12px;align-items:flex-start}
    .images-col{width:160px;flex-shrink:0}
    .equipment-image{width:140px;height:100px;object-fit:cover;border-radius:8px;flex-shrink:0;background:#eee;display:block;margin-bottom:6px}
    .equipment-info{flex:1}
    .equipment-prefix{font-weight:700;color:var(--primary);margin-bottom:6px}
    .equipment-sub{color:var(--gray);font-size:0.95rem;margin-bottom:6px}
    .equipment-details{color:var(--gray);font-size:0.9rem;margin-bottom:6px}
    .equipment-actions{display:flex;gap:8px;margin-top:8px}
    .edit-button,.copy-button,.delete-button{flex:1;color:#fff;border:none;padding:8px;border-radius:8px;cursor:pointer}
    .edit-button{background:linear-gradient(135deg,var(--secondary),#2980b9)}
    .copy-button{background:linear-gradient(135deg,#16a085,#1abc9c)}
    .delete-button{background:linear-gradient(135deg,var(--accent),#c0392b)}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center;z-index:2000;padding:20px}
    .modal.show{display:flex}
    .modal-content{background:#fff;border-radius:12px;padding:16px;max-width:980px;width:100%;max-height:90vh;overflow:auto;box-shadow:0 12px 36px rgba(0,0,0,.18)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .close-button{background:none;border:none;font-size:22px;cursor:pointer}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
    .form-group{margin-bottom:6px}
    .form-label{display:block;margin-bottom:6px;font-weight:600;color:var(--primary);font-size:0.95rem}
    .form-input,.form-select,.form-textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px}
    .form-textarea{min-height:90px;resize:vertical}
    .form-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}
    .cancel-button{background:#7f8c8d;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    .save-button{background:linear-gradient(135deg,var(--success),#27ae60);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    .notification{position:fixed;top:20px;right:20px;padding:12px 18px;border-radius:8px;color:#fff;display:none;z-index:3000}
    .notification.show{display:block}
    .notification.success{background:var(--success)}.notification.error{background:var(--accent)}
    .config-note{font-size:0.9rem;color:var(--gray);margin-bottom:8px}
    @media(max-width:920px){.form-row{grid-template-columns:1fr}.dashboard{grid-template-columns:1fr}.equipment-grid{grid-template-columns:1fr}}
  
    /* Image preview modal */
    .image-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);align-items:center;justify-content:center;z-index:3000;}
    .image-modal.show{display:flex;}
    .image-modal img{max-width:90%;max-height:90%;border-radius:12px;box-shadow:0 0 20px rgba(0,0,0,.5);}

</style>
</head>
<body>
  <div class="container">
    <header>
  <div style="display:flex;align-items:center;gap:12px;justify-content:center;">
    <div style="width:100px;height:70px;border-radius:6px;overflow:hidden;display:flex;align-items:center;justify-content:center;">
      <img src="https://raw.githubusercontent.com/Leandroxx10/controledeequip/refs/heads/main/file_00000000fbb46230a8c8a01e0f8354e6.png" 
           alt="Logo" 
           style="max-width:100%;max-height:100%;object-fit:contain;">
    </div>
    <h1><i class="fas fa-tools"></i> <span id="appTitle">Gerenciador de Equipamentos Completo</span></h1>
  </div>
  <p style="opacity:.9" class="config-note">Conectado ao Firestore: <strong>sistema de equipamentos</strong>.</p>
</header>

    <div class="top-controls">
      <div class="config-note" style="margin-right:8px;">Conectado ao Firestore: <strong>sistema de equipamentos</strong></div>
      <div style="flex:1"></div>
      <select id="langToggle" class="lang-select" aria-label="Selecionar idioma">
        <option value="pt">Português</option>
        <option value="en">English</option>
        <option value="it">Italiano</option>
        <option value="zh">中文</option>
        <option value="ja">日本語</option>
      </select>
    </div>

    <div class="dashboard">
      <div class="dashboard-card">
        <div style="font-size:22px;font-weight:700" id="totalEquipment">0</div>
        <div style="color:var(--gray)"><span id="totalEquipmentLabel">Total de Equipamentos</span></div>
      </div>
      <div class="dashboard-card">
        <div style="font-size:22px;font-weight:700" id="totalProduction">0</div>
        <div style="color:var(--gray)"><span id="totalProductionLabel">Em Produção</span></div>
      </div>
      <div class="dashboard-card">
        <div style="font-size:22px;font-weight:700" id="totalOut">0</div>
        <div style="color:var(--gray)"><span id="totalOutLabel">Fora de Produção</span></div>
      </div>
    </div>

    <div class="search-container">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <h2 style="margin:0" id="listTitle">Lista de Equipamentos</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="add-button" id="addButton"><i class="fas fa-plus"></i> <span id="addBtnText">Novo Equipamento</span></button>
          <button class="defects-button" id="defectsButton"><i class="fas fa-exclamation-triangle"></i> <span id="defectsBtnText">Defeitos</span></button>
        </div>
      </div>

      <div class="filters" id="filters">
        <button class="filter-button active" data-filter="all"><span id="filterAll">Todos</span></button>
        <button class="filter-button" data-filter="production"><span id="filterProduction">Em Produção</span></button>
        <button class="filter-button" data-filter="out"><span id="filterOut">Fora de Produção</span></button>
      </div>

      <div class="search-box" style="margin-top:8px">
        <input id="searchInput" class="search-input" placeholder="Buscar por prefixo (Molde / Blank)..." />
        <button id="searchButton" class="search-button"><i class="fas fa-search"></i> <span id="searchBtnText">Procurar</span></button>
      </div>
    </div>

    <div id="equipmentGrid" class="equipment-grid"></div>

    <footer style="text-align:center;margin-top:18px;color:var(--gray)">
      Sistema de Gerenciamento de Equipamentos — Versão Completa
    </footer>
  </div>

  <!-- Add/Edit Modal with requested fields and exact order -->
  <div class="modal" id="addModal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h3 id="addModalTitle"><i class="fas fa-plus"></i> <span id="addModalTitleText">Novo Equipamento</span></h3>
        <button class="close-button" data-close="addModal">&times;</button>
      </div>
      <form id="addForm">
        <!-- 1. Prefixo Molde / Molde Almoxarifado -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="addPrefixoMolde">Prefixo Molde</label>
            <input id="addPrefixoMolde" class="form-input" required />
          </div>
          <div class="form-group">
            <label class="form-label" for="addMoldeAlmox">Molde Almoxarifado</label>
            <select id="addMoldeAlmox" class="form-select">
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
              <option value="11">11</option>
              <option value="12">12</option>
              <option value="13">13</option>
              <option value="14">14</option>
              <option value="15">15</option>
              <option value="16">16</option>
              <option value="17">17</option>
              <option value="18">18</option>
              <option value="19">19</option>
              <option value="20">20</option>
              <option value="20+">20+</option>
            </select>
          </div>
        </div>

        <!-- 2. Prefixo Blank / Blank Almoxarifado -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="addPrefixoBlank">Prefixo Blank</label>
            <input id="addPrefixoBlank" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="addBlankAlmox">Blank Almoxarifado</label>
            <select id="addBlankAlmox" class="form-select">
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
              <option value="11">11</option>
              <option value="12">12</option>
              <option value="13">13</option>
              <option value="14">14</option>
              <option value="15">15</option>
              <option value="16">16</option>
              <option value="17">17</option>
              <option value="18">18</option>
              <option value="19">19</option>
              <option value="20">20</option>
              <option value="20+">20+</option>
            </select>
          </div>
        </div>

        <!-- Processo / Classe -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="addProcesso">Processo</label>
            <select id="addProcesso" class="form-select" required>
              <option value="SG">SG</option><option value="DG">DG</option><option value="TG">TG</option><option value="QG">QG</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="addClasse">Classe</label>
            <select id="addClasse" class="form-select">
              <option>Classe A</option><option>Classe B</option><option>Classe C</option>
            </select>
          </div>
        </div>

        <!-- Neckrings / Aneis Guias -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="addNeckrings">Neckrings</label>
            <input id="addNeckrings" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="addAneisGuias">Aneis Guias</label>
            <input id="addAneisGuias" class="form-input" />
          </div>
        </div>

        <!-- Thimbles / Machos -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="addThimble">Thimbles</label>
            <input id="addThimble" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="addMachos">Machos</label>
            <input id="addMachos" class="form-input" />
          </div>
        </div>

        <!-- Coolers / Baffles -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="addCoolers">Coolers</label>
            <input id="addCoolers" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="addBaffles">Baffles</label>
            <input id="addBaffles" class="form-input" />
          </div>
        </div>

        <!-- Baffles Plugs / Funis -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="addBafflesPlugs">Baffles Plugs</label>
            <input id="addBafflesPlugs" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="addFunis">Funis</label>
            <input id="addFunis" class="form-input" />
          </div>
        </div>

        <!-- Fundos / Fundos Plugs -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="addFundos">Fundos</label>
            <input id="addFundos" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="addFundosPlugs">Fundos Plugs</label>
            <input id="addFundosPlugs" class="form-input" />
          </div>
        </div>

        <!-- Sopradores / Pinças -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="addSopradores">Sopradores</label>
            <input id="addSopradores" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="addPincas">Pinças</label>
            <input id="addPincas" class="form-input" />
          </div>
        </div>

        <!-- Corredor select 1..15 / Prateleira -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="addCorredor">Corredor</label>
            <select id="addCorredor" class="form-select">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
              <option value="11">11</option>
              <option value="12">12</option>
              <option value="13">13</option>
              <option value="14">14</option>
              <option value="15">15</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="addPrateleira">Prateleira</label>
            <input id="addPrateleira" class="form-input" />
          </div>
        </div>

        <!-- Observações -->
        <div class="form-row">
          <div class="form-group" style="grid-column:1/-1">
            <label class="form-label" for="addObservacoesTopo">Observações</label>
            <input id="addObservacoesTopo" class="form-input" />
          </div>
        </div>

        <!-- Tipo de Polimento Molde / Tipo de Polimento Blank -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="addPolimentoMolde">Tipo de Polimento Molde</label>
            <select id="addPolimentoMolde" class="form-select">
              <option>Na madeira</option><option>Na máquina</option><option>Na politriz</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="addPolimentoBlank">Tipo de Polimento Blank</label>
            <select id="addPolimentoBlank" class="form-select">
              <option>Na madeira</option><option>Na máquina</option><option>Na politriz</option><option>Sem Polimento</option>
            </select>
          </div>
        </div>

        <!-- Observações Ajustagem / Observações Causas de Troca -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="addObservacaoAjustagem">Observações Ajustagem</label>
            <input id="addObservacaoAjustagem" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="addCausasTroca">Observações / Causas de Troca</label>
            <input id="addCausasTroca" class="form-input" />
          </div>
        </div>

        <!-- Dimensional Gargalo / Dimensional Corpo -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="addDiametroGargalo">Dimensional do Gargalo (mm)</label>
            <input id="addDiametroGargalo" type="number" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="addDiametroCorpo">Dimensional do Corpo (mm)</label>
            <input id="addDiametroCorpo" type="number" class="form-input" />
          </div>
        </div>

        <!-- Observações Adicionais / Status -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="addObservacoesAdicionais">Observações Adicionais</label>
            <input id="addObservacoesAdicionais" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="addStatus">Status</label>
            <select id="addStatus" class="form-select">
              <option value="production">Em produção</option>
              <option value="out">Fora de produção</option>
              <option value="sample">Amostra</option>
            </select>
          </div>
        </div>

        <!-- Images -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="addUrlImg1">URL da imagem 1</label>
            <input id="addUrlImg1" class="form-input" placeholder="https://..." />
          </div>
          <div class="form-group">
            <label class="form-label" for="addUrlImg2">URL da imagem 2</label>
            <input id="addUrlImg2" class="form-input" placeholder="https://..." />
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="cancel-button" data-close="addModal"><span id="cancelBtnText">Cancelar</span></button>
          <button type="submit" class="save-button"><span id="saveBtnText">Salvar</span></button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit modal (same fields, same order) -->
  <div class="modal" id="editModal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="editModalTitle"><i class="fas fa-edit"></i> <span id="editModalTitleText">Editar Equipamento</span></h3>
        <button class="close-button" data-close="editModal">&times;</button>
      </div>
      <form id="editForm">
        <input type="hidden" id="editId" />
        <!-- fields replicated with edit* ids -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="editPrefixoMolde">Prefixo Molde</label>
            <input id="editPrefixoMolde" class="form-input" required />
          </div>
          <div class="form-group">
            <label class="form-label" for="editMoldeAlmox">Molde Almoxarifado</label>
            <select id="editMoldeAlmox" class="form-select">
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
              <option value="11">11</option>
              <option value="12">12</option>
              <option value="13">13</option>
              <option value="14">14</option>
              <option value="15">15</option>
              <option value="16">16</option>
              <option value="17">17</option>
              <option value="18">18</option>
              <option value="19">19</option>
              <option value="20">20</option>
              <option value="20+">20+</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="editPrefixoBlank">Prefixo Blank</label>
            <input id="editPrefixoBlank" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="editBlankAlmox">Blank Almoxarifado</label>
            <select id="editBlankAlmox" class="form-select">
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
              <option value="11">11</option>
              <option value="12">12</option>
              <option value="13">13</option>
              <option value="14">14</option>
              <option value="15">15</option>
              <option value="16">16</option>
              <option value="17">17</option>
              <option value="18">18</option>
              <option value="19">19</option>
              <option value="20">20</option>
              <option value="20+">20+</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="editProcesso">Processo</label>
            <select id="editProcesso" class="form-select" required>
              <option value="SG">SG</option><option value="DG">DG</option><option value="TG">TG</option><option value="QG">QG</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="editClasse">Classe</label>
            <select id="editClasse" class="form-select">
              <option>Classe A</option><option>Classe B</option><option>Classe C</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="editNeckrings">Neckrings</label>
            <input id="editNeckrings" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="editAneisGuias">Aneis Guias</label>
            <input id="editAneisGuias" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="editThimble">Thimbles</label>
            <input id="editThimble" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="editMachos">Machos</label>
            <input id="editMachos" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="editCoolers">Coolers</label>
            <input id="editCoolers" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="editBaffles">Baffles</label>
            <input id="editBaffles" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="editBafflesPlugs">Baffles Plugs</label>
            <input id="editBafflesPlugs" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="editFunis">Funis</label>
            <input id="editFunis" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="editFundos">Fundos</label>
            <input id="editFundos" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="editFundosPlugs">Fundos Plugs</label>
            <input id="editFundosPlugs" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="editSopradores">Sopradores</label>
            <input id="editSopradores" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="editPincas">Pinças</label>
            <input id="editPincas" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="editCorredor">Corredor</label>
            <select id="editCorredor" class="form-select">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
              <option value="11">11</option>
              <option value="12">12</option>
              <option value="13">13</option>
              <option value="14">14</option>
              <option value="15">15</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="editPrateleira">Prateleira</label>
            <input id="editPrateleira" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group" style="grid-column:1/-1">
            <label class="form-label" for="editObservacoesTopo">Observações</label>
            <input id="editObservacoesTopo" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="editPolimentoMolde">Tipo de Polimento Molde</label>
            <select id="editPolimentoMolde" class="form-select">
              <option>Na madeira</option><option>Na máquina</option><option>Na politriz</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="editPolimentoBlank">Tipo de Polimento Blank</label>
            <select id="editPolimentoBlank" class="form-select">
              <option>Na madeira</option><option>Na máquina</option><option>Na politriz</option><option>Sem Polimento</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="editObservacaoAjustagem">Observações Ajustagem</label>
            <input id="editObservacaoAjustagem" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="editCausasTroca">Observações / Causas de Troca</label>
            <input id="editCausasTroca" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="editDiametroGargalo">Dimensional do Gargalo (mm)</label>
            <input id="editDiametroGargalo" type="number" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="editDiametroCorpo">Dimensional do Corpo (mm)</label>
            <input id="editDiametroCorpo" type="number" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="editObservacoesAdicionais">Observações Adicionais</label>
            <input id="editObservacoesAdicionais" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="editStatus">Status</label>
            <select id="editStatus" class="form-select">
              <option value="production">Em produção</option>
              <option value="out">Fora de produção</option>
              <option value="sample">Amostra</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="editUrlImg1">URL da imagem 1</label>
            <input id="editUrlImg1" class="form-input" placeholder="https://..." />
          </div>
          <div class="form-group">
            <label class="form-label" for="editUrlImg2">URL da imagem 2</label>
            <input id="editUrlImg2" class="form-input" placeholder="https://..." />
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="cancel-button" data-close="editModal"><span id="cancelEditBtnText">Cancelar</span></button>
          <button type="submit" class="save-button"><span id="saveEditBtnText">Salvar Alterações</span></button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Defeitos -->
  <div class="modal" id="defectsModal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-exclamation-triangle"></i> <span id="defectsModalTitle">Defeitos</span></h3>
        <button class="close-button" data-close="defectsModal">&times;</button>
      </div>
      <div class="form-group">
        <label class="form-label" for="defectSelect">Selecione o defeito</label>
        <select id="defectSelect" class="form-select">
          <option value="">-- Selecione --</option>
          <option value="H-">H-</option>
          <option value="H+">H+</option>
          <option value="C-">C-</option>
          <option value="C+">C+</option>
          <option value="Ombro Negativo">Ombro Negativo</option>
          <option value="Friso">Friso</option>
          <option value="Rebarba na terminação">Rebarba na terminação</option>
          <option value="Marca de Molde">Marca de Molde</option>
          <option value="Equipamento fora de Centro">Equipamento fora de Centro</option>
          <option value="Pressão">Pressão</option>
          <option value="Costura">Costura</option>
        </select>
      </div>
      <div class="form-group" id="defectInfo" style="display:none">
        <label class="form-label"> O que é| O que causa | Solução</label>
        <textarea id="defectText" class="form-textarea" readonly></textarea>
      </div>
    </div>
  </div>

  <div id="notification" class="notification"></div>

<script>
/* Full integration with the user's firebaseConfig embedded.
   Collection used: equipments_v1
*/

const firebaseConfig = {
  apiKey: "AIzaSyCGWcYx0EjUMfp7Up4BJIFlZBamOldsBZM",
  authDomain: "sistema-equipamentos-web.firebaseapp.com",
  projectId: "sistema-equipamentos-web",
  storageBucket: "sistema-equipamentos-web.firebasestorage.app",
  messagingSenderId: "1004971035686",
  appId: "1:1004971035686:web:c2de0aa19167b9a9246ae7"
};

const ADMIN_PASSWORD = 'wmoldes2026';
let useFirestore = false;
let db = null;
let unsubSnapshot = null;
let equipmentData = [];
let currentFilter = 'all';
let currentLang = 'pt';

const equipmentGrid = document.getElementById('equipmentGrid');
const addButton = document.getElementById('addButton');
const addModal = document.getElementById('addModal');
const editModal = document.getElementById('editModal');
const addForm = document.getElementById('addForm');
const editForm = document.getElementById('editForm');
const searchInput = document.getElementById('searchInput');
const searchButton = document.getElementById('searchButton');
const filters = document.querySelectorAll('.filter-button');
const notificationEl = document.getElementById('notification');
const totalEquipment = document.getElementById('totalEquipment');
const totalProduction = document.getElementById('totalProduction');
const totalOut = document.getElementById('totalOut');
const langToggle = document.getElementById('langToggle');
const defectsButton = document.getElementById('defectsButton');
const defectsModal = document.getElementById('defectsModal');
const defectSelect = document.getElementById('defectSelect');
const defectInfo = document.getElementById('defectInfo');
const defectText = document.getElementById('defectText');

function showNotification(msg, type='success') {
  notificationEl.textContent = msg;
  notificationEl.className = 'notification show ' + (type==='success' ? 'success' : 'error');
  setTimeout(()=>{ notificationEl.className = 'notification'; }, 3000);
}
function openModal(modal) { modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); }
function closeModal(modal) { modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }

document.querySelectorAll('[data-close]').forEach(btn=>{
  btn.addEventListener('click', (e)=>{
    const id = btn.getAttribute('data-close');
    const m = document.getElementById(id);
    if (m) closeModal(m);
  });
});
document.querySelectorAll('.modal').forEach(mod=>{
  mod.addEventListener('click', (e)=>{
    if (e.target === mod) closeModal(mod);
  });
});

// localStorage helpers
const STORAGE_KEY = 'equipments_v1';
function persistLocal() { localStorage.setItem(STORAGE_KEY, JSON.stringify(equipmentData)); }
function loadLocal() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (raw) {
    try { equipmentData = JSON.parse(raw); } catch(e){ equipmentData = []; }
  } else {
    equipmentData = [];
    persistLocal();
  }
}

// Translations (basic UI strings)
const translations = {
  pt: {
    appTitle: 'Gerenciador de Equipamentos Completo',
    connected: 'Conectado ao Firestore: <strong>sistema de equipamentos</strong>.',
    totalEquipmentLabel: 'Total de Equipamentos',
    totalProductionLabel: 'Em Produção',
    totalOutLabel: 'Fora de Produção',
    listTitle: 'Lista de Equipamentos',
    addNew: 'Adicionar Equipamento',
    defects: 'Defeitos',
    filterAll: 'Todos',
    filterProduction: 'Em Produção',
    filterOut: 'Fora de Produção',
    searchPlaceholder: 'Buscar por prefixo (Molde / Blank)...',
    searchButton: 'Procurar',
    addModalTitle: 'Novo Equipamento',
    editModalTitle: 'Editar Equipamento',
    saveButton: 'Salvar',
    cancelButton: 'Cancelar',
    editButton: 'Editar',
    deleteButton: 'Excluir',
    copyButton: 'Copiar',
    notificationCopied: 'Dados copiados!'
  },
  en: {
    appTitle: 'Equipment Manager Complete',
    connected: 'Connected to Firestore: <strong>equipment system</strong>.',
    totalEquipmentLabel: 'Total Equipment',
    totalProductionLabel: 'In Production',
    totalOutLabel: 'Out of Production',
    listTitle: 'Equipment List',
    addNew: 'New Equipment',
    defects: 'Defects',
    filterAll: 'All',
    filterProduction: 'In Production',
    filterOut: 'Out of Production',
    searchPlaceholder: 'Search by prefix (Mold / Blank)...',
    searchButton: 'Search',
    addModalTitle: 'New Equipment',
    editModalTitle: 'Edit Equipment',
    saveButton: 'Save',
    cancelButton: 'Cancel',
    editButton: 'Edit',
    deleteButton: 'Delete',
    copyButton: 'Copy',
    notificationCopied: 'Data copied!'
  },
  it: {
    appTitle: 'Gestore di Attrezzature Completo',
    connected: 'Connesso a Firestore: <strong>sistema attrezzature</strong>.',
    totalEquipmentLabel: 'Totale Attrezzature',
    totalProductionLabel: 'In Produzione',
    totalOutLabel: 'Fuori Produzione',
    listTitle: 'Elenco Attrezzature',
    addNew: 'Nuova Attrezzatura',
    defects: 'Difetti',
    filterAll: 'Tutti',
    filterProduction: 'In Produzione',
    filterOut: 'Fuori Produzione',
    searchPlaceholder: 'Cerca per prefisso (Matrice / Blank)...',
    searchButton: 'Cerca',
    addModalTitle: 'Nuova Attrezzatura',
    editModalTitle: 'Modifica Attrezzatura',
    saveButton: 'Salva',
    cancelButton: 'Annulla',
    editButton: 'Modifica',
    deleteButton: 'Elimina',
    copyButton: 'Copia',
    notificationCopied: 'Dati copiati!'
  },
  zh: {
    appTitle: '完整设备管理器',
    connected: '已连接到 Firestore：<strong>设备系统</strong>。',
    totalEquipmentLabel: '设备总数',
    totalProductionLabel: '生产中',
    totalOutLabel: '停止生产',
    listTitle: '设备列表',
    addNew: '新增设备',
    defects: '缺陷',
    filterAll: '全部',
    filterProduction: '生产中',
    filterOut: '停止生产',
    searchPlaceholder: '按前缀搜索（模具 / 毛坯）...',
    searchButton: '搜索',
    addModalTitle: '新增设备',
    editModalTitle: '编辑设备',
    saveButton: '保存',
    cancelButton: '取消',
    editButton: '编辑',
    deleteButton: '删除',
    copyButton: '复制',
    notificationCopied: '已复制数据！'
  },
  ja: {
    appTitle: '設備管理システム（完全版）',
    connected: 'Firestore に接続済み: <strong>設備システム</strong>。',
    totalEquipmentLabel: '設備合計',
    totalProductionLabel: '稼働中',
    totalOutLabel: '稼働外',
    listTitle: '設備一覧',
    addNew: '新規設備',
    defects: '不良',
    filterAll: 'すべて',
    filterProduction: '稼働中',
    filterOut: '稼働外',
    searchPlaceholder: '接頭辞で検索（金型 / ブランク）...',
    searchButton: '検索',
    addModalTitle: '新規設備',
    editModalTitle: '設備を編集',
    saveButton: '保存',
    cancelButton: 'キャンセル',
    editButton: '編集',
    deleteButton: '削除',
    copyButton: 'コピー',
    notificationCopied: 'データをコピーしました！'
  }
};

function applyLanguage(lang) {
  currentLang = lang;
  const t = translations[lang] || translations.pt;
  document.getElementById('appTitle').textContent = t.appTitle;
  document.querySelectorAll('.config-note').forEach(el => el.innerHTML = t.connected);
  document.getElementById('totalEquipmentLabel').textContent = t.totalEquipmentLabel;
  document.getElementById('totalProductionLabel').textContent = t.totalProductionLabel;
  document.getElementById('totalOutLabel').textContent = t.totalOutLabel;
  document.getElementById('listTitle').textContent = t.listTitle;
  document.getElementById('addBtnText').textContent = t.addNew;
  document.getElementById('defectsBtnText').textContent = t.defects;
  document.getElementById('filterAll').textContent = t.filterAll;
  document.getElementById('filterProduction').textContent = t.filterProduction;
  document.getElementById('filterOut').textContent = t.filterOut;
  document.getElementById('searchInput').placeholder = t.searchPlaceholder;
  document.getElementById('searchBtnText').textContent = t.searchButton;
  document.getElementById('addModalTitleText').textContent = t.addModalTitle;
  document.getElementById('editModalTitleText').textContent = t.editModalTitle;
  document.getElementById('saveBtnText').textContent = t.saveButton;
  document.getElementById('cancelBtnText') && (document.getElementById('cancelBtnText').textContent = t.cancelButton);
  document.getElementById('cancelEditBtnText') && (document.getElementById('cancelEditBtnText').textContent = t.cancelButton);
  document.getElementById('saveEditBtnText') && (document.getElementById('saveEditBtnText').textContent = t.saveButton);
  // Re-render equipment to update per-card button labels
  renderEquipment(applyCurrentFilterArray());
}

langToggle.addEventListener('change', (e) => {
  applyLanguage(e.target.value);
});

// Render helpers
function renderEquipment(list) {
  equipmentGrid.innerHTML = '';
  if (!list || list.length === 0) {
    equipmentGrid.innerHTML = '<div style="grid-column:1/-1;background:#fff;padding:20px;border-radius:12px;box-shadow:var(--shadow);text-align:center">Nenhum equipamento encontrado.</div>';
    updateDashboard();
    return;
  }
  const t = translations[currentLang] || translations.pt;
  list.forEach(eq => {
    const card = document.createElement('div'); card.className = 'equipment-card';
    let imgHtml = '';
    if (eq.urlImg1) imgHtml += `<img class="equipment-image" src="${eq.urlImg1}" alt="Imagem 1">`;
    if (eq.urlImg2) imgHtml += `<img class="equipment-image" src="${eq.urlImg2}" alt="Imagem 2">`;
    if (!imgHtml) imgHtml = `<div class="equipment-image"></div>`;
    card.innerHTML = `
      <div class="images-col">
        ${imgHtml}
      </div>
      <div class="equipment-info">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="equipment-prefix">${eq.prefixoMolde || '-'}</div>
            <div class="equipment-sub">Blank: ${eq.prefixoBlank || '-'}</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:700">Classe: ${eq.classe || '-'}</div>
            <div style="font-size:0.85rem;color:${eq.status==='production' ? '#27ae60' : (eq.status==='sample' ? '#f39c12' : '#c0392b')}">
              ${eq.status==='production' ? 'Em produção' : (eq.status==='sample' ? 'Amostra' : 'Fora')}
            </div>
          </div>
        </div>
        <div class="equipment-details">Neckrings: ${eq.neckrings || '-'} • Aneis Guias: ${eq.aneisGuias || '-'}</div>
        <div class="equipment-details">Almox Molde: ${eq.moldeAlmox || '-'} • Almox Blank: ${eq.blankAlmox || '-'}</div>
        <div class="equipment-actions">
          <button class="edit-button" data-id="${eq.id}"><i class="fas fa-edit"></i> ${t.editButton}</button>
          <button class="copy-button" data-id="${eq.id}"><i class="fas fa-copy"></i> ${t.copyButton}</button>
          <button class="delete-button" data-id="${eq.id}"><i class="fas fa-trash"></i> ${t.deleteButton}</button>
        </div>
      </div>
    `;
    equipmentGrid.appendChild(card);
  });

  // attach actions
  document.querySelectorAll('.edit-button').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const id = btn.getAttribute('data-id');
      openEditModal(id);
    });
  });
  document.querySelectorAll('.copy-button').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const id = btn.getAttribute('data-id');
      const eq = equipmentData.find(x=>x.id===id);
      if (!eq) return;
      // Prefer a human-readable copy payload
      const copyText = `
Prefixo Molde: ${eq.prefixoMolde || ''}
Prefixo Blank: ${eq.prefixoBlank || ''}
Processo: ${eq.processo || ''}
Neckrings: ${eq.neckrings || ''}
Aneis Guias: ${eq.aneisGuias || ''}
Thimbles: ${eq.thimble || ''}
Machos: ${eq.machos || ''}
Coolers: ${eq.coolers || ''}
Baffles: ${eq.baffles || ''}
Baffles Plugs: ${eq.bafflesPlugs || ''}
Funis: ${eq.funis || ''}
Fundos: ${eq.fundos || ''}
Fundos Plugs: ${eq.fundosPlugs || ''}
Sopradores: ${eq.sopradores || ''}
Pinças: ${eq.pincas || ''}
Almox Molde: ${eq.moldeAlmox || ''}
Almox Blank: ${eq.blankAlmox || ''}
Corredor: ${eq.corredor || ''}
Prateleira: ${eq.prateleira || ''}
`;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(copyText).then(()=> {
          showNotification(translations[currentLang].notificationCopied);
        }).catch(err=>{
          // fallback
          const ta = document.createElement('textarea');
          ta.value = copyText;
          document.body.appendChild(ta);
          ta.select();
          try { document.execCommand('copy'); showNotification(translations[currentLang].notificationCopied); } catch(e){ alert('Copy failed'); }
          ta.remove();
        });
      } else {
        const ta = document.createElement('textarea');
        ta.value = copyText;
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand('copy'); showNotification(translations[currentLang].notificationCopied); } catch(e){ alert('Copy failed'); }
        ta.remove();
      }
    });
  });
  document.querySelectorAll('.delete-button').forEach(btn=>{
    btn.addEventListener('click', async (e)=>{
      const id = btn.getAttribute('data-id');
      const senha = prompt('Digite a senha de autorização para excluir:');
      if (senha !== ADMIN_PASSWORD) { alert('Senha incorreta. Exclusão cancelada.'); return; }
      if (!confirm('Confirmar exclusão?')) return;
      try {
        if (useFirestore && db) {
          await deleteFromFirestore(id);
        } else {
          equipmentData = equipmentData.filter(x=>x.id !== id);
          persistLocal();
          renderEquipment(applyCurrentFilterArray());
        }
        showNotification('Equipamento excluído com sucesso!');
      } catch(err){
        console.error(err);
        showNotification('Erro ao excluir. Veja console.','error');
      }
    });
  });

  updateDashboard();
}

function updateDashboard() {
  totalEquipment.textContent = equipmentData.length;
  totalProduction.textContent = equipmentData.filter(e=>e.status==='production').length;
  totalOut.textContent = equipmentData.filter(e=>e.status!=='production').length;
}

function applyCurrentFilterArray() {
  return equipmentData.filter(e=>{
    if (currentFilter === 'all') return true;
    return e.status === currentFilter;
  });
}

function loadAndRender() {
  if (useFirestore && db) return;
  loadLocal();
  renderEquipment(applyCurrentFilterArray());
}

// Filters & Search
filters.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    filters.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.getAttribute('data-filter');
    renderEquipment(applyCurrentFilterArray());
  });
});

searchButton.addEventListener('click', searchEquipment);
searchInput.addEventListener('keypress', (e)=>{ if (e.key === 'Enter') searchEquipment(); });
// filtro automático conforme digita:
searchInput.addEventListener('input', searchEquipment);

function searchEquipment() {
  const term = (searchInput.value || '').trim().toLowerCase();
  if (!term) { renderEquipment(applyCurrentFilterArray()); return; }
  const result = equipmentData.filter(e=>{
    const pm = (e.prefixoMolde||'').toLowerCase();
    const pb = (e.prefixoBlank||'').toLowerCase();
    return (pm.includes(term) || pb.includes(term) || (e.moldeAlmox||'').toLowerCase().includes(term)) && (currentFilter==='all' ? true : e.status===currentFilter);
  });
  renderEquipment(result);
}

// Add
addButton.addEventListener('click', ()=>{
  document.getElementById('addForm').reset();
  openModal(addModal);
});
addForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const novo = {
    prefixoMolde: document.getElementById('addPrefixoMolde').value || '',
    moldeAlmox: document.getElementById('addMoldeAlmox').value || '',
    prefixoBlank: document.getElementById('addPrefixoBlank').value || '',
    blankAlmox: document.getElementById('addBlankAlmox').value || '',
    processo: document.getElementById('addProcesso').value || '',
    classe: document.getElementById('addClasse').value || '',
    neckrings: document.getElementById('addNeckrings').value || '',
    aneisGuias: document.getElementById('addAneisGuias').value || '',
    thimble: document.getElementById('addThimble').value || '',
    machos: document.getElementById('addMachos').value || '',
    coolers: document.getElementById('addCoolers').value || '',
    baffles: document.getElementById('addBaffles').value || '',
    bafflesPlugs: document.getElementById('addBafflesPlugs').value || '',
    funis: document.getElementById('addFunis').value || '',
    fundos: document.getElementById('addFundos').value || '',
    fundosPlugs: document.getElementById('addFundosPlugs').value || '',
    sopradores: document.getElementById('addSopradores').value || '',
    pincas: document.getElementById('addPincas').value || '',
    corredor: document.getElementById('addCorredor').value || '',
    prateleira: document.getElementById('addPrateleira').value || '',
    observacoesTopo: document.getElementById('addObservacoesTopo').value || '',
    polimentoMolde: document.getElementById('addPolimentoMolde').value || '',
    polimentoBlank: document.getElementById('addPolimentoBlank').value || '',
    observacaoAjustagem: document.getElementById('addObservacaoAjustagem').value || '',
    causasTroca: document.getElementById('addCausasTroca').value || '',
    diametroGargalo: Number(document.getElementById('addDiametroGargalo').value) || 0,
    diametroCorpo: Number(document.getElementById('addDiametroCorpo').value) || 0,
    observacoesAdicionais: document.getElementById('addObservacoesAdicionais').value || '',
    status: document.getElementById('addStatus').value || 'production',
    urlImg1: document.getElementById('addUrlImg1').value || '',
    urlImg2: document.getElementById('addUrlImg2').value || '',
    criadoEm: new Date().toISOString()
  };
  const senha = prompt('Digite a senha de autorização para salvar:');
  if (senha !== ADMIN_PASSWORD) { alert('Senha incorreta. Operação cancelada.'); return; }
  try {
    if (useFirestore && db) {
      await addToFirestore(novo);
    } else {
      novo.id = String(Date.now());
      equipmentData.push(novo);
      persistLocal();
      renderEquipment(applyCurrentFilterArray());
    }
    closeModal(addModal);
    showNotification('Equipamento adicionado com sucesso!');
  } catch(err){
    console.error(err);
    showNotification('Erro ao salvar. Veja console.','error');
  }
});

// Edit
function openEditModal(id) {
  const eq = equipmentData.find(x=>x.id===id);
  if (!eq) return alert('Equipamento não encontrado');
  document.getElementById('editId').value = eq.id;
  document.getElementById('editPrefixoMolde').value = eq.prefixoMolde || '';
  document.getElementById('editMoldeAlmox').value = eq.moldeAlmox || '';
  document.getElementById('editPrefixoBlank').value = eq.prefixoBlank || '';
  document.getElementById('editBlankAlmox').value = eq.blankAlmox || '';
  document.getElementById('editProcesso').value = eq.processo || '';
  document.getElementById('editClasse').value = eq.classe || '';
  document.getElementById('editNeckrings').value = eq.neckrings || '';
  document.getElementById('editAneisGuias').value = eq.aneisGuias || '';
  document.getElementById('editThimble').value = eq.thimble || '';
  document.getElementById('editMachos').value = eq.machos || '';
  document.getElementById('editCoolers').value = eq.coolers || '';
  document.getElementById('editBaffles').value = eq.baffles || '';
  document.getElementById('editBafflesPlugs').value = eq.bafflesPlugs || '';
  document.getElementById('editFunis').value = eq.funis || '';
  document.getElementById('editFundos').value = eq.fundos || '';
  document.getElementById('editFundosPlugs').value = eq.fundosPlugs || '';
  document.getElementById('editSopradores').value = eq.sopradores || '';
  document.getElementById('editPincas').value = eq.pincas || '';
  document.getElementById('editCorredor').value = eq.corredor || '';
  document.getElementById('editPrateleira').value = eq.prateleira || '';
  document.getElementById('editObservacoesTopo').value = eq.observacoesTopo || '';
  document.getElementById('editPolimentoMolde').value = eq.polimentoMolde || '';
  document.getElementById('editPolimentoBlank').value = eq.polimentoBlank || '';
  document.getElementById('editObservacaoAjustagem').value = eq.observacaoAjustagem || '';
  document.getElementById('editCausasTroca').value = eq.causasTroca || '';
  document.getElementById('editDiametroGargalo').value = eq.diametroGargalo || '';
  document.getElementById('editDiametroCorpo').value = eq.diametroCorpo || '';
  document.getElementById('editObservacoesAdicionais').value = eq.observacoesAdicionais || '';
  document.getElementById('editStatus').value = eq.status || 'production';
  document.getElementById('editUrlImg1').value = eq.urlImg1 || '';
  document.getElementById('editUrlImg2').value = eq.urlImg2 || '';
  openModal(editModal);
}
editForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const senha = prompt('Digite a senha de autorização para salvar alterações:');
  if (senha !== ADMIN_PASSWORD) { alert('Senha incorreta. Operação cancelada.'); return; }

  const id = document.getElementById('editId').value;
  const payload = {
    prefixoMolde: document.getElementById('editPrefixoMolde').value || '',
    moldeAlmox: document.getElementById('editMoldeAlmox').value || '',
    prefixoBlank: document.getElementById('editPrefixoBlank').value || '',
    blankAlmox: document.getElementById('editBlankAlmox').value || '',
    processo: document.getElementById('editProcesso').value || '',
    classe: document.getElementById('editClasse').value || '',
    neckrings: document.getElementById('editNeckrings').value || '',
    aneisGuias: document.getElementById('editAneisGuias').value || '',
    thimble: document.getElementById('editThimble').value || '',
    machos: document.getElementById('editMachos').value || '',
    coolers: document.getElementById('editCoolers').value || '',
    baffles: document.getElementById('editBaffles').value || '',
    bafflesPlugs: document.getElementById('editBafflesPlugs').value || '',
    funis: document.getElementById('editFunis').value || '',
    fundos: document.getElementById('editFundos').value || '',
    fundosPlugs: document.getElementById('editFundosPlugs').value || '',
    sopradores: document.getElementById('editSopradores').value || '',
    pincas: document.getElementById('editPincas').value || '',
    corredor: document.getElementById('editCorredor').value || '',
    prateleira: document.getElementById('editPrateleira').value || '',
    observacoesTopo: document.getElementById('editObservacoesTopo').value || '',
    polimentoMolde: document.getElementById('editPolimentoMolde').value || '',
    polimentoBlank: document.getElementById('editPolimentoBlank').value || '',
    observacaoAjustagem: document.getElementById('editObservacaoAjustagem').value || '',
    causasTroca: document.getElementById('editCausasTroca').value || '',
    diametroGargalo: Number(document.getElementById('editDiametroGargalo').value) || 0,
    diametroCorpo: Number(document.getElementById('editDiametroCorpo').value) || 0,
    observacoesAdicionais: document.getElementById('editObservacoesAdicionais').value || '',
    status: document.getElementById('editStatus').value || 'production',
    urlImg1: document.getElementById('editUrlImg1').value || '',
    urlImg2: document.getElementById('editUrlImg2').value || ''
  };
  try {
    if (useFirestore && db) {
      await updateFirestore(id, payload);
    } else {
      const idx = equipmentData.findIndex(x=>x.id===id);
      if (idx === -1) return alert('ID não encontrado');
      equipmentData[idx] = Object.assign({}, equipmentData[idx], payload);
      persistLocal();
      renderEquipment(applyCurrentFilterArray());
    }
    closeModal(editModal);
    showNotification('Alterações salvas.');
  } catch(err){
    console.error(err);
    showNotification('Erro ao salvar. Veja console.','error');
  }
});


// Image preview logic
const imageModal = document.getElementById('imageModal');
const imageModalImg = document.getElementById('imageModalImg');
document.addEventListener('click',(e)=>{
  if(e.target.classList.contains('equipment-image')){
    imageModalImg.src = e.target.src;
    imageModal.classList.add('show');
  } else if(e.target === imageModal){
    imageModal.classList.remove('show');
    imageModalImg.src = '';
  }
});

// Firestore functions & init
async function initFirestoreWithConfig(cfg) {
  try {
    const [{ initializeApp }, firestoreModule] = await Promise.all([
      import('https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js'),
      import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js')
    ]);
    const { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, deleteDoc, updateDoc } = firestoreModule;
    const app = initializeApp(cfg);
    db = getFirestore(app);
    useFirestore = true;
    const colRef = collection(db, 'equipments_v1');
    if (typeof onSnapshot === 'function') {
      if (unsubSnapshot) unsubSnapshot();
      unsubSnapshot = onSnapshot(colRef, (snapshot)=>{
        equipmentData = [];
        snapshot.forEach(snap => {
          equipmentData.push(Object.assign({id: snap.id}, snap.data()));
        });
        equipmentData.sort((a,b)=> (b.criadoEm || '') > (a.criadoEm || '') ? 1 : -1);
        renderEquipment(applyCurrentFilterArray());
      }, (err)=> {
        console.error('onSnapshot error', err);
        showNotification('Erro na sincronização com Firestore. Veja console.','error');
      });
    }
    showNotification('Conectado ao Firestore com sucesso!');
  } catch(err){
    console.error('initFirestore error', err);
    showNotification('Falha ao conectar Firestore. Usando fallback local.', 'error');
    useFirestore = false;
    db = null;
    loadLocal();
    renderEquipment(applyCurrentFilterArray());
  }
}

async function addToFirestore(obj) {
  const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
  const { collection, addDoc } = firestoreModule;
  const colRef = collection(db, 'equipments_v1');
  const res = await addDoc(colRef, obj);
  return res.id;
}
async function updateFirestore(id, payload) {
  const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
  const { doc, setDoc } = firestoreModule;
  const docRef = doc(db, 'equipments_v1', id);
  await setDoc(docRef, payload, { merge: true });
}
async function deleteFromFirestore(id) {
  const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
  const { doc, deleteDoc } = firestoreModule;
  const docRef = doc(db, 'equipments_v1', id);
  await deleteDoc(docRef);
}

// Defects modal logic
defectsButton.addEventListener('click', ()=> openModal(defectsModal));
defectSelect.addEventListener('change', ()=>{
  if (!defectSelect.value) { defectInfo.style.display='none'; defectText.value=''; return; }
  defectInfo.style.display='block';
  if (defectSelect.value==='H+') defectText.value = 'Causa: choque térmico ou impacto.\nSolução: substituir a peça ou aplicar solda especializada e inspecionar procedimento de produção.';
  if (defectSelect.value==='H-') defectText.value = 'Causa: uso prolongado e atrito.\nSolução: polimento, ajuste de tolerâncias e substituição conforme ciclo de vida.';(defectSelect.value==='desgaste')
  if (defectSelect.value==='C+') defectText.value = 'Causa: exposição à umidade/ambiente corrosivo.\nSolução: limpeza, tratamento e proteção com óleo ou revestimento.';
  if (defectSelect.value==='C-') defectText.value = 'Causa: exposição à umidade/ambiente corrosivo.\nSolução: limpeza, tratamento e proteção com óleo ou revestimento.';
});

// Auto-init Firestore with embedded config
initFirestoreWithConfig(firebaseConfig);

// Init fallback
(function init(){
  if (!useFirestore) {
    loadLocal();
    applyLanguage('pt');
    renderEquipment(applyCurrentFilterArray());
  } else {
    applyLanguage('pt');
  }
})();
</script>

  <!-- Image Preview Modal -->
  <div id="imageModal" class="image-modal">
    <img id="imageModalImg" src="" alt="Preview">
  </div>

</body>
</html>
