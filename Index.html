<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Gerenciador de Equipamentos — Firestore Integrado (Completo)</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root{--primary:#2c3e50;--secondary:#3498db;--success:#2ecc71;--accent:#e74c3c;--light:#ecf0f1;--dark:#2c3e50;--gray:#7f8c8d;--radius:12px;--shadow:0 6px 18px rgba(0,0,0,0.08);}
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Montserrat',sans-serif}
    body{background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);color:var(--dark);min-height:100vh;padding:20px}
    .container{max-width:1400px;margin:0 auto}
    header{background:linear-gradient(135deg,var(--primary),#1a2530);color:#fff;padding:18px;border-radius:12px;text-align:center;box-shadow:var(--shadow);margin-bottom:18px}
    h1{font-size:1.6rem}
    .top-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .dashboard{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:18px}
    .dashboard-card{background:#fff;padding:14px;border-radius:10px;text-align:center;box-shadow:var(--shadow)}
    .search-container{background:#fff;padding:14px;border-radius:10px;box-shadow:var(--shadow);margin-bottom:18px}
    .search-box{display:flex;gap:12px;align-items:center}
    .search-input{flex:1;padding:10px;border-radius:50px;border:1px solid #ddd}
    .add-button,.search-button{padding:10px 14px;border-radius:50px;border:none;cursor:pointer}
    .add-button{background:var(--success);color:#fff}
    .search-button{background:linear-gradient(135deg,var(--secondary),#2980b9);color:#fff}
    .filters{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap}
    .filter-button{padding:8px 14px;border-radius:50px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .filter-button.active{background:var(--secondary);color:#fff;border-color:var(--secondary)}
    .equipment-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:18px}
    .equipment-card{background:#fff;border-radius:12px;box-shadow:var(--shadow);overflow:hidden;padding:12px;display:flex;gap:12px;align-items:flex-start}
    .equipment-image{width:140px;height:100px;object-fit:cover;border-radius:8px;flex-shrink:0;background:#eee}
    .equipment-info{flex:1}
    .equipment-prefix{font-weight:700;color:var(--primary);margin-bottom:6px}
    .equipment-sub{color:var(--gray);font-size:0.95rem;margin-bottom:6px}
    .equipment-details{color:var(--gray);font-size:0.9rem;margin-bottom:6px}
    .equipment-actions{display:flex;gap:8px;margin-top:8px}
    .edit-button{flex:1;background:linear-gradient(135deg,var(--secondary),#2980b9);color:#fff;border:none;padding:8px;border-radius:8px;cursor:pointer}
    .delete-button{flex:1;background:linear-gradient(135deg,var(--accent),#c0392b);color:#fff;border:none;padding:8px;border-radius:8px;cursor:pointer}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center;z-index:2000;padding:20px}
    .modal.show{display:flex}
    .modal-content{background:#fff;border-radius:12px;padding:16px;max-width:980px;width:100%;max-height:90vh;overflow:auto;box-shadow:0 12px 36px rgba(0,0,0,.18)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .close-button{background:none;border:none;font-size:22px;cursor:pointer}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
    .form-group{margin-bottom:6px}
    .form-label{display:block;margin-bottom:6px;font-weight:600;color:var(--primary);font-size:0.95rem}
    .form-input,.form-select,.form-textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px}
    .form-textarea{min-height:90px;resize:vertical}
    .form-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}
    .cancel-button{background:#7f8c8d;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    .save-button{background:linear-gradient(135deg,var(--success),#27ae60);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    .notification{position:fixed;top:20px;right:20px;padding:12px 18px;border-radius:8px;color:#fff;display:none;z-index:3000}
    .notification.show{display:block}
    .notification.success{background:var(--success)}.notification.error{background:var(--accent)}
    .config-note{font-size:0.9rem;color:var(--gray);margin-bottom:8px}
    @media(max-width:920px){.form-row{grid-template-columns:1fr}.dashboard{grid-template-columns:1fr}.equipment-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-tools"></i> Gerenciador de Equipamentos — Completo</h1>
      <p style="opacity:.9">Integrado ao Firestore do seu projeto — coleção <strong>equipments_v1</strong>.</p>
    </header>

    <div class="top-controls">
      <div class="config-note">Conectado ao Firestore: <strong>sistema-equipamentos-web</strong></div>
      <div style="flex:1"></div>
      <button id="downloadBtn" class="filter-button"><i class="fas fa-download"></i> Baixar HTML atual</button>
    </div>

    <div class="dashboard">
      <div class="dashboard-card">
        <div style="font-size:22px;font-weight:700" id="totalEquipment">0</div>
        <div style="color:var(--gray)">Total de Equipamentos</div>
      </div>
      <div class="dashboard-card">
        <div style="font-size:22px;font-weight:700" id="totalProduction">0</div>
        <div style="color:var(--gray)">Em Produção</div>
      </div>
      <div class="dashboard-card">
        <div style="font-size:22px;font-weight:700" id="totalOut">0</div>
        <div style="color:var(--gray)">Fora de Produção</div>
      </div>
    </div>

    <div class="search-container">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <h2 style="margin:0">Lista de Equipamentos</h2>
        <button class="add-button" id="addButton"><i class="fas fa-plus"></i> Novo Equipamento</button>
      </div>

      <div class="filters" id="filters">
        <button class="filter-button active" data-filter="all">Todos</button>
        <button class="filter-button" data-filter="production">Em Produção</button>
        <button class="filter-button" data-filter="out">Fora de Produção</button>
      </div>

      <div class="search-box" style="margin-top:8px">
        <input id="searchInput" class="search-input" placeholder="Buscar por prefixo (Molde / Blank)..." />
        <button id="searchButton" class="search-button"><i class="fas fa-search"></i> Procurar</button>
      </div>
    </div>

    <div id="equipmentGrid" class="equipment-grid"></div>

    <footer style="text-align:center;margin-top:18px;color:var(--gray)">
      Sistema de Gerenciamento de Equipamentos — Versão Completa
    </footer>
  </div>

  <!-- Add/Edit Modal with all requested fields -->
  <div class="modal" id="addModal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h3 id="addModalTitle"><i class="fas fa-plus"></i> Novo Equipamento</h3>
        <button class="close-button" data-close="addModal">&times;</button>
      </div>
      <form id="addForm">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="addPrefixoMolde">PREFIXO MOLDE</label>
            <input id="addPrefixoMolde" class="form-input" required />
          </div>
          <div class="form-group">
            <label class="form-label" for="addPrefixoBlank">PREFIXO BLANK</label>
            <input id="addPrefixoBlank" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="addProcesso">PROCESSO</label>
            <select id="addProcesso" class="form-select" required>
              <option value="SG">SG</option><option value="DG">DG</option><option value="TG">TG</option><option value="QG">QG</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="addClasse">CLASSE</label>
            <select id="addClasse" class="form-select">
              <option>Classe A</option><option>Classe B</option><option>Classe C</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="addNeckrings">NECKRINGS</label>
            <input id="addNeckrings" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="addAneisGuias">ANEIS GUIAS</label>
            <input id="addAneisGuias" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="addThimble">THIMBLE</label>
            <input id="addThimble" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="addMachos">MACHOS</label>
            <input id="addMachos" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="addCoolers">COOLERS</label>
            <input id="addCoolers" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="addFundos">FUNDOS</label>
            <input id="addFundos" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="addFundosPlugs">FUNDOS PLUGS</label>
            <input id="addFundosPlugs" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="addBaffle">BAFFLE</label>
            <input id="addBaffle" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="addBafflesPlug">BAFFLES PLUG</label>
            <input id="addBafflesPlug" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="addPolimento">TIPO DE POLIMENTO</label>
            <select id="addPolimento" class="form-select">
              <option>Na madeira</option><option>Na máquina</option><option>Na politriz</option>
            </select>
          </div>
        </div>

        <!-- existing fields -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="addDiametroGargalo">Diâmetro do Gargalo (mm)</label>
            <input id="addDiametroGargalo" type="number" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="addDiametroCorpo">Diâmetro do Corpo (mm)</label>
            <input id="addDiametroCorpo" type="number" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="addPrateleira">Prateleira</label>
            <input id="addPrateleira" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="addCorredor">Corredor</label>
            <input id="addCorredor" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="addUrlImg1">URL da imagem 1</label>
            <input id="addUrlImg1" class="form-input" placeholder="https://..." />
          </div>
          <div class="form-group">
            <label class="form-label" for="addUrlImg2">URL da imagem 2</label>
            <input id="addUrlImg2" class="form-input" placeholder="https://..." />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group" style="grid-column:1/-1">
            <label class="form-label" for="addObservacaoAjustagem">Observação Ajustagem</label>
            <input id="addObservacaoAjustagem" class="form-input" />
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="addCausasTroca">Observações / Causas de Troca</label>
          <textarea id="addCausasTroca" class="form-textarea"></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="addStatus">Status</label>
            <select id="addStatus" class="form-select">
              <option value="production">Em Produção</option>
              <option value="out">Fora de Produção</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="addObservacoes">Observações Adicionais</label>
            <input id="addObservacoes" class="form-input" />
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="cancel-button" data-close="addModal">Cancelar</button>
          <button type="submit" class="save-button">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit modal -->
  <div class="modal" id="editModal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="editModalTitle"><i class="fas fa-edit"></i> Editar Equipamento</h3>
        <button class="close-button" data-close="editModal">&times;</button>
      </div>
      <form id="editForm">
        <input type="hidden" id="editId" />
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="editPrefixoMolde">PREFIXO MOLDE</label>
            <input id="editPrefixoMolde" class="form-input" required />
          </div>
          <div class="form-group">
            <label class="form-label" for="editPrefixoBlank">PREFIXO BLANK</label>
            <input id="editPrefixoBlank" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="editProcesso">PROCESSO</label>
            <select id="editProcesso" class="form-select" required>
              <option value="SG">SG</option><option value="DG">DG</option><option value="TG">TG</option><option value="QG">QG</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="editClasse">CLASSE</label>
            <select id="editClasse" class="form-select">
              <option>Classe A</option><option>Classe B</option><option>Classe C</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="editNeckrings">NECKRINGS</label>
            <input id="editNeckrings" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="editAneisGuias">ANEIS GUIAS</label>
            <input id="editAneisGuias" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="editThimble">THIMBLE</label>
            <input id="editThimble" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="editMachos">MACHOS</label>
            <input id="editMachos" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="editCoolers">COOLERS</label>
            <input id="editCoolers" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="editFundos">FUNDOS</label>
            <input id="editFundos" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="editFundosPlugs">FUNDOS PLUGS</label>
            <input id="editFundosPlugs" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="editBaffle">BAFFLE</label>
            <input id="editBaffle" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="editBafflesPlug">BAFFLES PLUG</label>
            <input id="editBafflesPlug" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="editPolimento">TIPO DE POLIMENTO</label>
            <select id="editPolimento" class="form-select">
              <option>Na madeira</option><option>Na máquina</option><option>Na politriz</option>
            </select>
          </div>
        </div>

        <!-- existing fields replicated -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="editDiametroGargalo">Diâmetro do Gargalo (mm)</label>
            <input id="editDiametroGargalo" type="number" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="editDiametroCorpo">Diâmetro do Corpo (mm)</label>
            <input id="editDiametroCorpo" type="number" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="editPrateleira">Prateleira</label>
            <input id="editPrateleira" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label" for="editCorredor">Corredor</label>
            <input id="editCorredor" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="editUrlImg1">URL da imagem 1</label>
            <input id="editUrlImg1" class="form-input" placeholder="https://..." />
          </div>
          <div class="form-group">
            <label class="form-label" for="editUrlImg2">URL da imagem 2</label>
            <input id="editUrlImg2" class="form-input" placeholder="https://..." />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group" style="grid-column:1/-1">
            <label class="form-label" for="editObservacaoAjustagem">Observação Ajustagem</label>
            <input id="editObservacaoAjustagem" class="form-input" />
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="editCausasTroca">Observações / Causas de Troca</label>
          <textarea id="editCausasTroca" class="form-textarea"></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="editStatus">Status</label>
            <select id="editStatus" class="form-select">
              <option value="production">Em Produção</option>
              <option value="out">Fora de Produção</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="editObservacoes">Observações Adicionais</label>
            <input id="editObservacoes" class="form-input" />
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="cancel-button" data-close="editModal">Cancelar</button>
          <button type="submit" class="save-button">Salvar Alterações</button>
        </div>
      </form>
    </div>
  </div>

  <div id="notification" class="notification"></div>

<script>
/* Full integration with the user's firebaseConfig embedded.
   Collection used: equipments_v1
   Note: This file contains your firebaseConfig as provided.
*/

/* ====== User-provided firebaseConfig (embedded) ====== */
const firebaseConfig = {
  apiKey: "AIzaSyCGWcYx0EjUMfp7Up4BJIFlZBamOldsBZM",
  authDomain: "sistema-equipamentos-web.firebaseapp.com",
  projectId: "sistema-equipamentos-web",
  storageBucket: "sistema-equipamentos-web.firebasestorage.app",
  messagingSenderId: "1004971035686",
  appId: "1:1004971035686:web:c2de0aa19167b9a9246ae7"
};
/* ===================================================== */

const ADMIN_PASSWORD = 'wmoldes2026';
let useFirestore = false;
let db = null;
let unsubSnapshot = null;
let equipmentData = [];
let currentFilter = 'all';
let isAuthenticated = false;

const equipmentGrid = document.getElementById('equipmentGrid');
const addButton = document.getElementById('addButton');
const addModal = document.getElementById('addModal');
const editModal = document.getElementById('editModal');
const addForm = document.getElementById('addForm');
const editForm = document.getElementById('editForm');
const searchInput = document.getElementById('searchInput');
const searchButton = document.getElementById('searchButton');
const filters = document.querySelectorAll('.filter-button');
const notificationEl = document.getElementById('notification');
const totalEquipment = document.getElementById('totalEquipment');
const totalProduction = document.getElementById('totalProduction');
const totalOut = document.getElementById('totalOut');

function showNotification(msg, type='success') {
  notificationEl.textContent = msg;
  notificationEl.className = 'notification show ' + (type==='success' ? 'success' : 'error');
  setTimeout(()=>{ notificationEl.className = 'notification'; }, 3000);
}
function openModal(modal) { modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); }
function closeModal(modal) { modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }

document.querySelectorAll('[data-close]').forEach(btn=>{
  btn.addEventListener('click', (e)=>{
    const id = btn.getAttribute('data-close');
    const m = document.getElementById(id);
    if (m) closeModal(m);
  });
});
document.querySelectorAll('.modal').forEach(mod=>{
  mod.addEventListener('click', (e)=>{
    if (e.target === mod) closeModal(mod);
  });
});

// localStorage helpers
const STORAGE_KEY = 'equipments_v1';
function persistLocal() { localStorage.setItem(STORAGE_KEY, JSON.stringify(equipmentData)); }
function loadLocal() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (raw) {
    try { equipmentData = JSON.parse(raw); } catch(e){ equipmentData = []; }
  } else {
    equipmentData = []; // start empty
    persistLocal();
  }
}

// Render helpers
function renderEquipment(list) {
  equipmentGrid.innerHTML = '';
  if (!list || list.length === 0) {
    equipmentGrid.innerHTML = '<div style="grid-column:1/-1;background:#fff;padding:20px;border-radius:12px;box-shadow:var(--shadow);text-align:center">Nenhum equipamento encontrado.</div>';
    updateDashboard();
    return;
  }
  list.forEach(eq => {
    const card = document.createElement('div'); card.className = 'equipment-card';
    const imgUrl = eq.urlImg1 || eq.urlImg2 || '';
    const imgHtml = imgUrl ? `<img class="equipment-image" src="${imgUrl}" alt="Imagem">` : `<div class="equipment-image"></div>`;
    card.innerHTML = `
      ${imgHtml}
      <div class="equipment-info">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="equipment-prefix">${eq.prefixoMolde || '-'}</div>
            <div class="equipment-sub">${eq.prefixoBlank ? 'Blank: ' + eq.prefixoBlank : ''}</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:700">${eq.processo || '-'}</div>
            <div style="font-size:0.85rem;color:${eq.status==='production' ? '#27ae60' : '#c0392b'}">${eq.status==='production' ? 'Em produção' : 'Fora'}</div>
          </div>
        </div>

        <div class="equipment-details"><strong>Classe:</strong> ${eq.classe || '-' } • <strong>Polimento:</strong> ${eq.polimento || '-'}</div>
        <div class="equipment-details">Neckrings: ${eq.neckrings || '-'} • Aneis Guias: ${eq.aneisGuias || '-'}</div>
        <div class="equipment-details">Thimble: ${eq.thimble || '-'} • Machos: ${eq.machos || '-'}</div>
        <div class="equipment-details">Coolers: ${eq.coolers || '-'} • Fundos: ${eq.fundos || '-'} • Fundos Plugs: ${eq.fundosPlugs || '-'}</div>
        <div class="equipment-actions">
          <button class="edit-button" data-id="${eq.id}"><i class="fas fa-edit"></i> Editar</button>
          <button class="delete-button" data-id="${eq.id}"><i class="fas fa-trash"></i> Excluir</button>
        </div>
      </div>
    `;
    equipmentGrid.appendChild(card);
  });

  // attach actions
  document.querySelectorAll('.edit-button').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const id = btn.getAttribute('data-id');
      openEditModal(id);
    });
  });
  document.querySelectorAll('.delete-button').forEach(btn=>{
    btn.addEventListener('click', async (e)=>{
      const id = btn.getAttribute('data-id');
      const senha = prompt('Digite a senha de autorização para excluir:');
      if (senha !== ADMIN_PASSWORD) { alert('Senha incorreta. Exclusão cancelada.'); return; }
      if (!confirm('Confirmar exclusão?')) return;
      try {
        if (useFirestore && db) {
          await deleteFromFirestore(id);
        } else {
          equipmentData = equipmentData.filter(x=>x.id !== id);
          persistLocal();
          renderEquipment(applyCurrentFilterArray());
        }
        showNotification('Equipamento excluído com sucesso!');
      } catch(err){
        console.error(err);
        showNotification('Erro ao excluir. Veja console.','error');
      }
    });
  });

  updateDashboard();
}

function updateDashboard() {
  totalEquipment.textContent = equipmentData.length;
  totalProduction.textContent = equipmentData.filter(e=>e.status==='production').length;
  totalOut.textContent = equipmentData.filter(e=>e.status!=='production').length;
}

function applyCurrentFilterArray() {
  return equipmentData.filter(e=>{
    if (currentFilter === 'all') return true;
    return e.status === currentFilter;
  });
}

function loadAndRender() {
  if (useFirestore && db) return;
  loadLocal();
  renderEquipment(applyCurrentFilterArray());
}

// Filters & Search
filters.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    filters.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.getAttribute('data-filter');
    renderEquipment(applyCurrentFilterArray());
  });
});

searchButton.addEventListener('click', searchEquipment);
searchInput.addEventListener('keypress', (e)=>{ if (e.key === 'Enter') searchEquipment(); });
function searchEquipment() {
  const term = (searchInput.value || '').trim().toLowerCase();
  if (!term) { renderEquipment(applyCurrentFilterArray()); return; }
  const result = equipmentData.filter(e=>{
    const pm = (e.prefixoMolde||'').toLowerCase();
    const pb = (e.prefixoBlank||'').toLowerCase();
    return (pm.includes(term) || pb.includes(term)) && (currentFilter==='all' ? true : e.status===currentFilter);
  });
  renderEquipment(result);
}

// Add
addButton.addEventListener('click', ()=>{
  document.getElementById('addForm').reset();
  openModal(addModal);
});
addForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const novo = {
    prefixoMolde: document.getElementById('addPrefixoMolde').value || '',
    prefixoBlank: document.getElementById('addPrefixoBlank').value || '',
    processo: document.getElementById('addProcesso').value || '',
    classe: document.getElementById('addClasse').value || '',
    neckrings: document.getElementById('addNeckrings').value || '',
    aneisGuias: document.getElementById('addAneisGuias').value || '',
    thimble: document.getElementById('addThimble').value || '',
    machos: document.getElementById('addMachos').value || '',
    coolers: document.getElementById('addCoolers').value || '',
    fundos: document.getElementById('addFundos').value || '',
    fundosPlugs: document.getElementById('addFundosPlugs').value || '',
    baffle: document.getElementById('addBaffle').value || '',
    bafflesPlug: document.getElementById('addBafflesPlug').value || '',
    polimento: document.getElementById('addPolimento').value || '',
    diametroGargalo: Number(document.getElementById('addDiametroGargalo').value) || 0,
    diametroCorpo: Number(document.getElementById('addDiametroCorpo').value) || 0,
    prateleira: document.getElementById('addPrateleira').value || '',
    corredor: document.getElementById('addCorredor').value || '',
    urlImg1: document.getElementById('addUrlImg1').value || '',
    urlImg2: document.getElementById('addUrlImg2').value || '',
    observacaoAjustagem: document.getElementById('addObservacaoAjustagem').value || '',
    causasTroca: document.getElementById('addCausasTroca').value || '',
    status: document.getElementById('addStatus').value || 'production',
    observacoes: document.getElementById('addObservacoes').value || '',
    criadoEm: new Date().toISOString()
  };
  const senha = prompt('Digite a senha de autorização para salvar:');
  if (senha !== ADMIN_PASSWORD) { alert('Senha incorreta. Operação cancelada.'); return; }
  try {
    if (useFirestore && db) {
      await addToFirestore(novo);
      // Firestore snapshot will refresh UI
    } else {
      novo.id = String(Date.now());
      equipmentData.push(novo);
      persistLocal();
      renderEquipment(applyCurrentFilterArray());
    }
    closeModal(addModal);
    showNotification('Equipamento adicionado com sucesso!');
  } catch(err){
    console.error(err);
    showNotification('Erro ao salvar. Veja console.','error');
  }
});

// Edit
function openEditModal(id) {
  const eq = equipmentData.find(x=>x.id===id);
  if (!eq) return alert('Equipamento não encontrado');
  document.getElementById('editId').value = eq.id;
  document.getElementById('editPrefixoMolde').value = eq.prefixoMolde || '';
  document.getElementById('editPrefixoBlank').value = eq.prefixoBlank || '';
  document.getElementById('editProcesso').value = eq.processo || '';
  document.getElementById('editClasse').value = eq.classe || '';
  document.getElementById('editNeckrings').value = eq.neckrings || '';
  document.getElementById('editAneisGuias').value = eq.aneisGuias || '';
  document.getElementById('editThimble').value = eq.thimble || '';
  document.getElementById('editMachos').value = eq.machos || '';
  document.getElementById('editCoolers').value = eq.coolers || '';
  document.getElementById('editFundos').value = eq.fundos || '';
  document.getElementById('editFundosPlugs').value = eq.fundosPlugs || '';
  document.getElementById('editBaffle').value = eq.baffle || '';
  document.getElementById('editBafflesPlug').value = eq.bafflesPlug || '';
  document.getElementById('editPolimento').value = eq.polimento || '';
  document.getElementById('editDiametroGargalo').value = eq.diametroGargalo || '';
  document.getElementById('editDiametroCorpo').value = eq.diametroCorpo || '';
  document.getElementById('editPrateleira').value = eq.prateleira || '';
  document.getElementById('editCorredor').value = eq.corredor || '';
  document.getElementById('editUrlImg1').value = eq.urlImg1 || '';
  document.getElementById('editUrlImg2').value = eq.urlImg2 || '';
  document.getElementById('editObservacaoAjustagem').value = eq.observacaoAjustagem || '';
  document.getElementById('editCausasTroca').value = eq.causasTroca || '';
  document.getElementById('editStatus').value = eq.status || 'production';
  document.getElementById('editObservacoes').value = eq.observacoes || '';
  openModal(editModal);
}
editForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id = document.getElementById('editId').value;
  const payload = {
    prefixoMolde: document.getElementById('editPrefixoMolde').value || '',
    prefixoBlank: document.getElementById('editPrefixoBlank').value || '',
    processo: document.getElementById('editProcesso').value || '',
    classe: document.getElementById('editClasse').value || '',
    neckrings: document.getElementById('editNeckrings').value || '',
    aneisGuias: document.getElementById('editAneisGuias').value || '',
    thimble: document.getElementById('editThimble').value || '',
    machos: document.getElementById('editMachos').value || '',
    coolers: document.getElementById('editCoolers').value || '',
    fundos: document.getElementById('editFundos').value || '',
    fundosPlugs: document.getElementById('editFundosPlugs').value || '',
    baffle: document.getElementById('editBaffle').value || '',
    bafflesPlug: document.getElementById('editBafflesPlug').value || '',
    polimento: document.getElementById('editPolimento').value || '',
    diametroGargalo: Number(document.getElementById('editDiametroGargalo').value) || 0,
    diametroCorpo: Number(document.getElementById('editDiametroCorpo').value) || 0,
    prateleira: document.getElementById('editPrateleira').value || '',
    corredor: document.getElementById('editCorredor').value || '',
    urlImg1: document.getElementById('editUrlImg1').value || '',
    urlImg2: document.getElementById('editUrlImg2').value || '',
    observacaoAjustagem: document.getElementById('editObservacaoAjustagem').value || '',
    causasTroca: document.getElementById('editCausasTroca').value || '',
    status: document.getElementById('editStatus').value || 'production',
    observacoes: document.getElementById('editObservacoes').value || ''
  };
  try {
    if (useFirestore && db) {
      await updateFirestore(id, payload);
    } else {
      const idx = equipmentData.findIndex(x=>x.id===id);
      if (idx === -1) return alert('ID não encontrado');
      equipmentData[idx] = Object.assign({}, equipmentData[idx], payload);
      persistLocal();
      renderEquipment(applyCurrentFilterArray());
    }
    closeModal(editModal);
    showNotification('Alterações salvas.');
  } catch(err){
    console.error(err);
    showNotification('Erro ao salvar. Veja console.','error');
  }
});

// Firestore functions & init
async function initFirestoreWithConfig(cfg) {
  try {
    const [{ initializeApp }, firestoreModule] = await Promise.all([
      import('https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js'),
      import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js')
    ]);
    const { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, deleteDoc, updateDoc } = firestoreModule;
    const app = initializeApp(cfg);
    db = getFirestore(app);
    useFirestore = true;
    const colRef = collection(db, 'equipments_v1');
    if (typeof onSnapshot === 'function') {
      if (unsubSnapshot) unsubSnapshot();
      unsubSnapshot = onSnapshot(colRef, (snapshot)=>{
        equipmentData = [];
        snapshot.forEach(snap => {
          equipmentData.push(Object.assign({id: snap.id}, snap.data()));
        });
        // sort by criadoEm desc if present
        equipmentData.sort((a,b)=> (b.criadoEm || '') > (a.criadoEm || '') ? 1 : -1);
        renderEquipment(applyCurrentFilterArray());
      }, (err)=> {
        console.error('onSnapshot error', err);
        showNotification('Erro na sincronização com Firestore. Veja console.','error');
      });
    } else {
      // fallback load once
      showNotification('onSnapshot não disponível — carregando uma vez.');
    }
    showNotification('Conectado ao Firestore com sucesso!');
  } catch(err){
    console.error('initFirestore error', err);
    showNotification('Falha ao conectar Firestore. Usando fallback local.', 'error');
    useFirestore = false;
    db = null;
    loadLocal();
    renderEquipment(applyCurrentFilterArray());
  }
}

async function addToFirestore(obj) {
  const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
  const { collection, addDoc } = firestoreModule;
  const colRef = collection(db, 'equipments_v1');
  const res = await addDoc(colRef, obj);
  return res.id;
}
async function updateFirestore(id, payload) {
  const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
  const { doc, setDoc } = firestoreModule;
  const docRef = doc(db, 'equipments_v1', id);
  // merge so we don't wipe other fields
  await setDoc(docRef, payload, { merge: true });
}
async function deleteFromFirestore(id) {
  const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
  const { doc, deleteDoc } = firestoreModule;
  const docRef = doc(db, 'equipments_v1', id);
  await deleteDoc(docRef);
}

// Auto-init Firestore with embedded config
initFirestoreWithConfig(firebaseConfig);

// Download current HTML
document.getElementById('downloadBtn').addEventListener('click', ()=>{
  const doctype = '<!doctype html>\\n';
  const content = doctype + document.documentElement.outerHTML;
  const blob = new Blob([content], {type: 'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'testandoch_full_with_firestore_v2.html';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

// Init fallback
(function init(){
  if (!useFirestore) {
    loadLocal();
    renderEquipment(applyCurrentFilterArray());
  }
})();
</script>
</body>
</html>
